<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>GutSync - AI-Powered Crohn's Tracker</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            gut: {
              50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac',
              400: '#4ade80', 500: '#22c55e', 600: '#16a34a', 700: '#15803d',
              800: '#166534', 900: '#14532d'
            }
          }
        }
      }
    }
  </script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Inter', sans-serif; }
    .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }
    @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes pulse-ring { 0% { transform: scale(0.95); opacity: 0.8; } 50% { transform: scale(1.05); opacity: 0.4; } 100% { transform: scale(0.95); opacity: 0.8; } }
    @keyframes mic-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    .slide-up { animation: slideUp 0.3s ease-out; }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    .bristol-btn { transition: all 0.15s ease; }
    .bristol-btn:active { transform: scale(0.95); }
    .voice-btn-ring { animation: pulse-ring 2s ease-in-out infinite; }
    .mic-recording { animation: mic-pulse 1s ease-in-out infinite; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef, useMemo, useCallback } = React;
    
    // ============ DATA MODELS & STORAGE ============
    const STORAGE_KEYS = {
      USER: 'gutsync_user',
      LOGS: 'gutsync_logs',
      ONBOARDED: 'gutsync_onboarded'
    };
    
    const loadData = (key, defaultValue) => {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : defaultValue;
      } catch { return defaultValue; }
    };
    
    const saveData = (key, data) => {
      localStorage.setItem(key, JSON.stringify(data));
    };
    
    // Bristol Stool Scale definitions
    const BRISTOL_SCALE = [
      { type: 1, name: 'Separate hard lumps', desc: 'Constipation', emoji: 'üî¥', color: 'bg-red-500' },
      { type: 2, name: 'Lumpy sausage', desc: 'Mild constipation', emoji: 'üü†', color: 'bg-orange-500' },
      { type: 3, name: 'Cracked sausage', desc: 'Normal', emoji: 'üü°', color: 'bg-yellow-500' },
      { type: 4, name: 'Smooth snake', desc: 'Ideal', emoji: 'üü¢', color: 'bg-green-500' },
      { type: 5, name: 'Soft blobs', desc: 'Trending loose', emoji: 'üü°', color: 'bg-yellow-500' },
      { type: 6, name: 'Fluffy, ragged', desc: 'Diarrhea', emoji: 'üü†', color: 'bg-orange-500' },
      { type: 7, name: 'Entirely liquid', desc: 'Severe', emoji: 'üî¥', color: 'bg-red-500' }
    ];
    
    const EXTRA_SYMPTOMS = [
      { id: 'joint_pain', label: 'Joint Pain', icon: 'ü¶¥' },
      { id: 'skin_issues', label: 'Skin Issues', icon: 'üî¥' },
      { id: 'eye_problems', label: 'Eye Problems', icon: 'üëÅÔ∏è' },
      { id: 'nausea', label: 'Nausea', icon: 'ü§¢' },
      { id: 'mouth_sores', label: 'Mouth Sores', icon: 'üëÑ' },
      { id: 'fever', label: 'Fever', icon: 'üå°Ô∏è' },
      { id: 'fatigue', label: 'Fatigue', icon: 'üò¥' },
      { id: 'bloating', label: 'Bloating', icon: 'üéà' },
      { id: 'cramping', label: 'Cramping', icon: 'üí¢' },
      { id: 'blood', label: 'Blood in stool', icon: 'ü©∏' }
    ];
    
    const PAIN_LOCATIONS = [
      { id: 'rlq', label: 'Right Lower', x: 75, y: 65 },
      { id: 'llq', label: 'Left Lower', x: 25, y: 65 },
      { id: 'ruq', label: 'Right Upper', x: 75, y: 35 },
      { id: 'luq', label: 'Left Upper', x: 25, y: 35 },
      { id: 'periumbilical', label: 'Around Navel', x: 50, y: 50 },
      { id: 'epigastric', label: 'Upper Middle', x: 50, y: 25 }
    ];
    
    const DEFAULT_MEDICATIONS = [
      'Humira (adalimumab)',
      'Remicade (infliximab)',
      'Stelara (ustekinumab)',
      'Entyvio (vedolizumab)',
      'Prednisone',
      'Budesonide',
      'Azathioprine',
      'Methotrexate',
      'Mesalamine'
    ];
    
    // ============ AI INSIGHTS ENGINE (Rule-based) ============
    const generateInsights = (logs, user) => {
      if (logs.length < 3) {
        return { 
          status: 'neutral', 
          message: 'Keep logging to unlock AI insights', 
          details: 'We need at least 3 days of data to detect patterns.',
          riskPercent: null,
          riskLevel: null
        };
      }
      
      const recent = logs.slice(-7);
      const avgPain = recent.reduce((sum, l) => sum + (l.painLevel || 0), 0) / recent.length;
      const avgBowel = recent.reduce((sum, l) => sum + (l.bowelCount || 0), 0) / recent.length;
      const looseStools = recent.filter(l => l.bristolType >= 6).length;
      const avgFatigue = recent.reduce((sum, l) => sum + (5 - (l.fatigue || 3)), 0) / recent.length;
      
      // Calculate flare risk score (as percentage for 24-72 hour prediction window)
      let riskScore = 0;
      if (avgPain > 5) riskScore += 25;
      else if (avgPain > 3) riskScore += 12;
      if (avgBowel > 6) riskScore += 20;
      else if (avgBowel > 4) riskScore += 10;
      if (looseStools >= 4) riskScore += 30;
      else if (looseStools >= 2) riskScore += 15;
      if (avgFatigue > 2) riskScore += 15;
      else if (avgFatigue > 1) riskScore += 8;
      
      // Check for trends (rising symptoms = higher risk)
      if (recent.length >= 3) {
        const lastThree = recent.slice(-3);
        const painTrend = lastThree[2]?.painLevel - lastThree[0]?.painLevel;
        if (painTrend > 2) riskScore += 15;
        else if (painTrend > 0) riskScore += 5;
        
        const bowelTrend = lastThree[2]?.bowelCount - lastThree[0]?.bowelCount;
        if (bowelTrend > 2) riskScore += 10;
      }
      
      // Clamp to realistic clinical ranges
      const riskPercent = Math.min(Math.max(riskScore, 5), 85);
      
      if (riskPercent >= 50) {
        return {
          status: 'warning',
          riskLevel: 'high',
          riskPercent,
          message: 'Elevated flare risk detected',
          details: `Your symptoms suggest ${riskPercent}% chance of a flare in the next 24-72 hours. Pain averaging ${avgPain.toFixed(1)}/10 with ${looseStools} days of loose stools.`,
          recommendation: 'Contact your GI, prepare flare kit, rest and hydrate'
        };
      } else if (riskPercent >= 25) {
        return {
          status: 'caution',
          riskLevel: 'medium',
          riskPercent,
          message: 'Moderate symptom activity',
          details: `${riskPercent}% flare risk in next 24-72 hours. Average pain ${avgPain.toFixed(1)}/10. Monitor closely.`,
          recommendation: 'Monitor closely, consider reducing stress, stay hydrated'
        };
      } else {
        return {
          status: 'good',
          riskLevel: 'low',
          riskPercent,
          message: 'Looking good! Low flare risk üíö',
          details: `Only ${riskPercent}% flare risk. Pain averaging ${avgPain.toFixed(1)}/10 with ${avgBowel.toFixed(1)} BM/day.`,
          recommendation: 'Continue tracking, stay hydrated, maintain routine'
        };
      }
    };
    
    const calculateHBI = (log) => {
      // Harvey-Bradshaw Index estimate
      let score = 0;
      score += Math.min(4, Math.floor((5 - (log.fatigue || 3)) * 1.33)); // General well-being 0-4
      score += Math.min(3, Math.floor((log.painLevel || 0) / 3.33)); // Pain 0-3
      score += Math.max(0, (log.bowelCount || 0) - 2); // Liquid stools beyond 2
      return score;
    };
    
    // Find last flare (defined as high pain + high bowel count day)
    const findLastFlare = (logs) => {
      const sortedLogs = [...logs].sort((a, b) => new Date(b.date) - new Date(a.date));
      for (const log of sortedLogs) {
        if ((log.painLevel >= 6 && log.bowelCount >= 5) || log.bristolType >= 6 && log.painLevel >= 5) {
          const flareDate = new Date(log.date);
          const today = new Date();
          const diffTime = today - flareDate;
          const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
          return { date: log.date, daysAgo: diffDays };
        }
      }
      return null;
    };
    
    // ============ VOICE RECOGNITION ============
    const useVoiceRecognition = () => {
      const [isListening, setIsListening] = useState(false);
      const [transcript, setTranscript] = useState('');
      const [isSupported, setIsSupported] = useState(false);
      const recognitionRef = useRef(null);
      
      useEffect(() => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
          setIsSupported(true);
          recognitionRef.current = new SpeechRecognition();
          recognitionRef.current.continuous = false;
          recognitionRef.current.interimResults = true;
          recognitionRef.current.lang = 'en-US';
          
          recognitionRef.current.onresult = (event) => {
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
              if (event.results[i].isFinal) {
                finalTranscript += event.results[i][0].transcript;
              }
            }
            if (finalTranscript) {
              setTranscript(finalTranscript);
            }
          };
          
          recognitionRef.current.onend = () => {
            setIsListening(false);
          };
          
          recognitionRef.current.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            setIsListening(false);
          };
        }
      }, []);
      
      const startListening = useCallback(() => {
        if (recognitionRef.current && !isListening) {
          setTranscript('');
          recognitionRef.current.start();
          setIsListening(true);
        }
      }, [isListening]);
      
      const stopListening = useCallback(() => {
        if (recognitionRef.current && isListening) {
          recognitionRef.current.stop();
          setIsListening(false);
        }
      }, [isListening]);
      
      return { isListening, transcript, isSupported, startListening, stopListening, setTranscript };
    };
    
    // Parse voice transcript into symptom data
    const parseVoiceInput = (transcript) => {
      const text = transcript.toLowerCase();
      const result = {
        painLevel: null,
        bowelCount: null,
        bristolType: null,
        extras: [],
        notes: transcript
      };
      
      // Pain level parsing
      const painMatch = text.match(/pain.{0,10}(\d+)|(\d+).{0,10}(out of|\/)\s*10|level.{0,5}(\d+)/);
      if (painMatch) {
        const num = parseInt(painMatch[1] || painMatch[2] || painMatch[4]);
        if (num >= 0 && num <= 10) result.painLevel = num;
      }
      if (text.includes('no pain') || text.includes('feeling good') || text.includes('feeling great')) result.painLevel = result.painLevel || 1;
      if (text.includes('mild pain') || text.includes('little pain')) result.painLevel = result.painLevel || 3;
      if (text.includes('moderate pain')) result.painLevel = result.painLevel || 5;
      if (text.includes('severe pain') || text.includes('bad pain') || text.includes('really hurts')) result.painLevel = result.painLevel || 7;
      if (text.includes('worst pain') || text.includes('terrible')) result.painLevel = result.painLevel || 9;
      
      // Bowel movements
      const bmMatch = text.match(/(\d+)\s*(bowel|bm|bathroom|times|movements?)/);
      if (bmMatch) {
        result.bowelCount = parseInt(bmMatch[1]);
      }
      if (text.includes('went once') || text.includes('one time')) result.bowelCount = result.bowelCount || 1;
      if (text.includes('went twice') || text.includes('two times')) result.bowelCount = result.bowelCount || 2;
      if (text.includes('three times')) result.bowelCount = result.bowelCount || 3;
      if (text.includes('many times') || text.includes('lot')) result.bowelCount = result.bowelCount || 5;
      
      // Bristol type
      if (text.includes('liquid') || text.includes('watery')) result.bristolType = 7;
      else if (text.includes('loose') || text.includes('soft')) result.bristolType = 6;
      else if (text.includes('normal') || text.includes('formed')) result.bristolType = 4;
      else if (text.includes('hard') || text.includes('constipated')) result.bristolType = 2;
      
      // Extra symptoms
      if (text.includes('joint') || text.includes('joints hurt')) result.extras.push('joint_pain');
      if (text.includes('skin') || text.includes('rash')) result.extras.push('skin_issues');
      if (text.includes('eye') || text.includes('eyes')) result.extras.push('eye_problems');
      if (text.includes('nausea') || text.includes('nauseous') || text.includes('queasy')) result.extras.push('nausea');
      if (text.includes('mouth sore') || text.includes('ulcer')) result.extras.push('mouth_sores');
      if (text.includes('fever') || text.includes('temperature')) result.extras.push('fever');
      if (text.includes('tired') || text.includes('fatigue') || text.includes('exhausted')) result.extras.push('fatigue');
      if (text.includes('bloat') || text.includes('bloating')) result.extras.push('bloating');
      if (text.includes('cramp') || text.includes('cramping')) result.extras.push('cramping');
      if (text.includes('blood')) result.extras.push('blood');
      
      return result;
    };
    
    // ============ COMPONENTS ============
    
    // Single-Page Onboarding
    const OnboardingFlow = ({ onComplete }) => {
      // Pre-populate with demo data
      const twoYearsAgo = new Date();
      twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
      const defaultDate = twoYearsAgo.toISOString().split('T')[0];
      
      const [diagnosisDate, setDiagnosisDate] = useState(defaultDate);
      const [medications, setMedications] = useState(['Humira (adalimumab)', 'Prednisone']);
      const [customMed, setCustomMed] = useState('');
      
      const handleMedToggle = (med) => {
        setMedications(prev => 
          prev.includes(med) ? prev.filter(m => m !== med) : [...prev, med]
        );
      };
      
      const finishOnboarding = () => {
        const userData = {
          diagnosisDate,
          medications,
          createdAt: new Date().toISOString()
        };
        saveData(STORAGE_KEYS.USER, userData);
        saveData(STORAGE_KEYS.ONBOARDED, true);
        
        // Add some demo log data for a better first experience
        const demoLogs = generateDemoLogs();
        saveData(STORAGE_KEYS.LOGS, demoLogs);
        
        onComplete(userData, demoLogs);
      };
      
      // Generate realistic demo logs
      const generateDemoLogs = () => {
        const logs = [];
        const today = new Date();
        
        for (let i = 14; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          
          // Simulate a mini-flare around 8 days ago
          const isFlareDay = i >= 7 && i <= 9;
          const isRecovery = i >= 4 && i <= 6;
          
          const painLevel = isFlareDay ? Math.floor(Math.random() * 3) + 6 : 
                           isRecovery ? Math.floor(Math.random() * 2) + 3 :
                           Math.floor(Math.random() * 3) + 1;
          
          const bowelCount = isFlareDay ? Math.floor(Math.random() * 3) + 5 :
                            isRecovery ? Math.floor(Math.random() * 2) + 3 :
                            Math.floor(Math.random() * 2) + 2;
          
          const bristolType = isFlareDay ? Math.floor(Math.random() * 2) + 6 :
                             isRecovery ? Math.floor(Math.random() * 2) + 4 :
                             Math.floor(Math.random() * 2) + 3;
          
          const fatigue = isFlareDay ? Math.floor(Math.random() * 2) + 1 :
                         isRecovery ? 3 :
                         Math.floor(Math.random() * 2) + 4;
          
          logs.push({
            date: date.toISOString().split('T')[0],
            timestamp: date.toISOString(),
            painLevel,
            bowelCount,
            bristolType,
            fatigue,
            medsTaken: ['Humira (adalimumab)', 'Prednisone'],
            extras: isFlareDay ? ['fatigue', 'cramping'] : [],
            notes: '',
            hbi: calculateHBI({ bowelCount, painLevel, fatigue })
          });
        }
        
        return logs;
      };
      
      return (
        <div className="min-h-screen bg-gradient-to-br from-gut-50 to-white p-6 fade-in">
          {/* Header */}
          <div className="text-center mb-8 pt-8">
            <div className="text-6xl mb-4">üåø</div>
            <h1 className="text-3xl font-bold text-gray-900 mb-2">Welcome to GutSync</h1>
            <p className="text-gray-600">Your AI-powered Crohn's companion</p>
          </div>
          
          {/* Quick Setup Form */}
          <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h2 className="text-lg font-semibold text-gray-900 mb-4">Quick Setup</h2>
            
            {/* Diagnosis Date */}
            <div className="mb-6">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                When were you diagnosed?
              </label>
              <input 
                type="date"
                value={diagnosisDate}
                onChange={(e) => setDiagnosisDate(e.target.value)}
                className="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-gut-500 focus:outline-none"
              />
            </div>
            
            {/* Medications */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">
                Current Medications
              </label>
              <div className="space-y-2 max-h-64 overflow-y-auto">
                {DEFAULT_MEDICATIONS.map(med => (
                  <button
                    key={med}
                    onClick={() => handleMedToggle(med)}
                    className={`w-full p-3 rounded-xl text-left text-sm transition flex items-center justify-between ${
                      medications.includes(med) 
                        ? 'bg-gut-100 border-2 border-gut-500 text-gut-700' 
                        : 'bg-gray-50 border-2 border-gray-200 text-gray-700'
                    }`}
                  >
                    <span>{med}</span>
                    {medications.includes(med) && <span className="text-gut-600 font-bold">‚úì</span>}
                  </button>
                ))}
              </div>
              
              {/* Custom medication */}
              <div className="flex gap-2 mt-3">
                <input 
                  type="text"
                  placeholder="Add other medication..."
                  value={customMed}
                  onChange={(e) => setCustomMed(e.target.value)}
                  className="flex-1 p-3 border-2 border-gray-200 rounded-xl text-sm focus:border-gut-500 focus:outline-none"
                />
                <button 
                  onClick={() => { 
                    if (customMed.trim()) { 
                      handleMedToggle(customMed.trim()); 
                      setCustomMed(''); 
                    }
                  }}
                  className="px-4 bg-gray-100 rounded-xl font-medium text-sm hover:bg-gray-200 transition"
                >
                  Add
                </button>
              </div>
            </div>
          </div>
          
          {/* Features Preview */}
          <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h3 className="font-semibold text-gray-900 mb-4">What you'll get:</h3>
            <div className="space-y-3">
              <div className="flex items-center gap-3">
                <span className="text-2xl">üé§</span>
                <span className="text-gray-700">Voice-powered symptom logging</span>
              </div>
              <div className="flex items-center gap-3">
                <span className="text-2xl">ü§ñ</span>
                <span className="text-gray-700">AI flare prediction (24-72 hours)</span>
              </div>
              <div className="flex items-center gap-3">
                <span className="text-2xl">üìä</span>
                <span className="text-gray-700">Trend analysis & insights</span>
              </div>
              <div className="flex items-center gap-3">
                <span className="text-2xl">üìã</span>
                <span className="text-gray-700">Doctor-ready reports</span>
              </div>
            </div>
          </div>
          
          {/* Start Button */}
          <button 
            onClick={finishOnboarding}
            className="w-full bg-gut-600 text-white py-4 rounded-xl font-semibold text-lg hover:bg-gut-700 transition shadow-lg"
          >
            Start Tracking üöÄ
          </button>
          
          <p className="text-center text-sm text-gray-500 mt-4">
            Demo data will be added for a better first experience
          </p>
        </div>
      );
    };
    
    // Voice Logging Modal
    const VoiceLogModal = ({ isOpen, onClose, onSave, user, existingLog }) => {
      const { isListening, transcript, isSupported, startListening, stopListening, setTranscript } = useVoiceRecognition();
      const [parsedData, setParsedData] = useState(null);
      const [showManualForm, setShowManualForm] = useState(false);
      const [manualData, setManualData] = useState({
        painLevel: existingLog?.painLevel || 3,
        bowelCount: existingLog?.bowelCount || 2,
        bristolType: existingLog?.bristolType || 4,
        fatigue: existingLog?.fatigue || 3,
        medsTaken: existingLog?.medsTaken || [],
        extras: existingLog?.extras || [],
        notes: existingLog?.notes || ''
      });
      
      useEffect(() => {
        if (transcript) {
          const parsed = parseVoiceInput(transcript);
          setParsedData(parsed);
        }
      }, [transcript]);
      
      const handleVoiceToggle = () => {
        if (isListening) {
          stopListening();
        } else {
          startListening();
        }
      };
      
      const handleSaveVoice = () => {
        const log = {
          date: new Date().toISOString().split('T')[0],
          timestamp: new Date().toISOString(),
          painLevel: parsedData?.painLevel || 3,
          bowelCount: parsedData?.bowelCount || 2,
          bristolType: parsedData?.bristolType || 4,
          fatigue: 3,
          medsTaken: user?.medications || [],
          extras: parsedData?.extras || [],
          notes: transcript,
          hbi: calculateHBI({ 
            bowelCount: parsedData?.bowelCount || 2, 
            painLevel: parsedData?.painLevel || 3, 
            fatigue: 3 
          })
        };
        onSave(log);
        onClose();
      };
      
      const handleSaveManual = () => {
        const log = {
          date: new Date().toISOString().split('T')[0],
          timestamp: new Date().toISOString(),
          ...manualData,
          hbi: calculateHBI(manualData)
        };
        onSave(log);
        onClose();
      };
      
      const simulateTranscription = () => {
        // For demo purposes when speech API isn't available
        const demoTranscripts = [
          "Pain level about 4, went to the bathroom 3 times today, stools were a bit loose, feeling some fatigue",
          "Feeling pretty good today, mild pain around 2, normal bowel movements twice",
          "Not great today, pain is about 6 out of 10, had 5 bowel movements, liquid stools, also feeling nauseous"
        ];
        const randomTranscript = demoTranscripts[Math.floor(Math.random() * demoTranscripts.length)];
        setTranscript(randomTranscript);
      };
      
      if (!isOpen) return null;
      
      return (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-end justify-center slide-up">
          <div className="bg-white rounded-t-3xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
            {/* Header */}
            <div className="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
              <h2 className="font-semibold text-lg">Log Symptoms</h2>
              <button onClick={onClose} className="text-gray-500 text-2xl">&times;</button>
            </div>
            
            <div className="p-6">
              {!showManualForm ? (
                <>
                  {/* Voice Recording Section */}
                  <div className="text-center mb-6">
                    <p className="text-gray-600 mb-6">
                      {isListening ? 'Listening... Speak your symptoms' : 'Tap and describe how you\'re feeling'}
                    </p>
                    
                    {/* Large Voice Button */}
                    <button
                      onClick={handleVoiceToggle}
                      disabled={!isSupported}
                      className={`relative w-32 h-32 rounded-full mx-auto flex items-center justify-center transition-all ${
                        isListening 
                          ? 'bg-red-500 scale-110' 
                          : 'bg-gut-500 hover:bg-gut-600'
                      } ${!isSupported ? 'opacity-50' : ''}`}
                    >
                      {isListening && (
                        <div className="absolute inset-0 rounded-full bg-red-400 voice-btn-ring" />
                      )}
                      <span className={`text-5xl ${isListening ? 'mic-recording' : ''}`}>üé§</span>
                    </button>
                    
                    {!isSupported && (
                      <p className="text-orange-600 text-sm mt-4">
                        Voice not supported in this browser. 
                        <button 
                          onClick={simulateTranscription}
                          className="underline ml-1"
                        >
                          Try demo
                        </button>
                      </p>
                    )}
                  </div>
                  
                  {/* Transcript Display */}
                  {transcript && (
                    <div className="bg-gray-50 rounded-xl p-4 mb-4">
                      <p className="text-sm text-gray-500 mb-1">You said:</p>
                      <p className="text-gray-800">"{transcript}"</p>
                    </div>
                  )}
                  
                  {/* Parsed Results */}
                  {parsedData && transcript && (
                    <div className="bg-gut-50 rounded-xl p-4 mb-6">
                      <p className="text-sm text-gut-700 font-medium mb-3">Detected symptoms:</p>
                      <div className="space-y-2 text-sm">
                        {parsedData.painLevel !== null && (
                          <div className="flex justify-between">
                            <span>Pain Level:</span>
                            <span className="font-medium">{parsedData.painLevel}/10</span>
                          </div>
                        )}
                        {parsedData.bowelCount !== null && (
                          <div className="flex justify-between">
                            <span>Bowel Movements:</span>
                            <span className="font-medium">{parsedData.bowelCount}</span>
                          </div>
                        )}
                        {parsedData.bristolType !== null && (
                          <div className="flex justify-between">
                            <span>Stool Type:</span>
                            <span className="font-medium">Bristol {parsedData.bristolType}</span>
                          </div>
                        )}
                        {parsedData.extras.length > 0 && (
                          <div className="flex justify-between">
                            <span>Other Symptoms:</span>
                            <span className="font-medium">{parsedData.extras.join(', ')}</span>
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                  
                  {/* Action Buttons */}
                  <div className="space-y-3">
                    {transcript && (
                      <button
                        onClick={handleSaveVoice}
                        className="w-full py-4 bg-gut-600 text-white rounded-xl font-semibold hover:bg-gut-700 transition"
                      >
                        Save Log ‚úì
                      </button>
                    )}
                    <button
                      onClick={() => setShowManualForm(true)}
                      className="w-full py-3 border-2 border-gray-200 text-gray-600 rounded-xl font-medium hover:bg-gray-50 transition"
                    >
                      Enter Manually Instead
                    </button>
                  </div>
                </>
              ) : (
                <>
                  {/* Manual Form */}
                  <div className="space-y-6">
                    {/* Pain Level */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Pain Level: {manualData.painLevel}/10
                      </label>
                      <input
                        type="range"
                        min="0"
                        max="10"
                        value={manualData.painLevel}
                        onChange={(e) => setManualData(d => ({ ...d, painLevel: parseInt(e.target.value) }))}
                        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                      />
                      <div className="flex justify-between text-xs text-gray-400 mt-1">
                        <span>None</span>
                        <span>Severe</span>
                      </div>
                    </div>
                    
                    {/* Bowel Count */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Bowel Movements Today
                      </label>
                      <div className="flex items-center justify-center gap-4">
                        <button 
                          onClick={() => setManualData(d => ({ ...d, bowelCount: Math.max(0, d.bowelCount - 1) }))}
                          className="w-12 h-12 bg-gray-100 rounded-full text-xl font-bold"
                        >‚àí</button>
                        <span className="text-3xl font-bold w-12 text-center">{manualData.bowelCount}</span>
                        <button 
                          onClick={() => setManualData(d => ({ ...d, bowelCount: d.bowelCount + 1 }))}
                          className="w-12 h-12 bg-gut-100 rounded-full text-xl font-bold text-gut-600"
                        >+</button>
                      </div>
                    </div>
                    
                    {/* Bristol Type */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Stool Consistency
                      </label>
                      <div className="flex gap-1">
                        {BRISTOL_SCALE.map(item => (
                          <button
                            key={item.type}
                            onClick={() => setManualData(d => ({ ...d, bristolType: item.type }))}
                            className={`flex-1 p-2 rounded-lg text-center transition ${
                              manualData.bristolType === item.type 
                                ? `${item.color} text-white` 
                                : 'bg-gray-100'
                            }`}
                          >
                            <div className="font-bold">{item.type}</div>
                          </button>
                        ))}
                      </div>
                    </div>
                    
                    {/* Extra Symptoms */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Other Symptoms
                      </label>
                      <div className="flex flex-wrap gap-2">
                        {EXTRA_SYMPTOMS.map(s => (
                          <button
                            key={s.id}
                            onClick={() => setManualData(d => ({
                              ...d,
                              extras: d.extras.includes(s.id) 
                                ? d.extras.filter(e => e !== s.id)
                                : [...d.extras, s.id]
                            }))}
                            className={`px-3 py-2 rounded-lg text-sm transition ${
                              manualData.extras.includes(s.id)
                                ? 'bg-orange-100 border-2 border-orange-400'
                                : 'bg-gray-100 border-2 border-transparent'
                            }`}
                          >
                            {s.icon} {s.label}
                          </button>
                        ))}
                      </div>
                    </div>
                    
                    {/* Notes */}
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        Notes (optional)
                      </label>
                      <textarea
                        value={manualData.notes}
                        onChange={(e) => setManualData(d => ({ ...d, notes: e.target.value }))}
                        placeholder="Food triggers, stress, etc..."
                        className="w-full p-3 border-2 border-gray-200 rounded-xl h-20 resize-none focus:border-gut-500 focus:outline-none"
                      />
                    </div>
                  </div>
                  
                  {/* Save Button */}
                  <div className="mt-6 space-y-3">
                    <button
                      onClick={handleSaveManual}
                      className="w-full py-4 bg-gut-600 text-white rounded-xl font-semibold hover:bg-gut-700 transition"
                    >
                      Save Log ‚úì
                    </button>
                    <button
                      onClick={() => setShowManualForm(false)}
                      className="w-full py-3 text-gray-500 font-medium"
                    >
                      ‚Üê Back to Voice
                    </button>
                  </div>
                </>
              )}
            </div>
          </div>
        </div>
      );
    };
    
    // New Dashboard
    const Dashboard = ({ user, logs, onCheckin, onViewInsights, onViewReport }) => {
      const insights = useMemo(() => generateInsights(logs, user), [logs, user]);
      const lastFlare = useMemo(() => findLastFlare(logs), [logs]);
      const [showVoiceModal, setShowVoiceModal] = useState(false);
      const chartRef = useRef(null);
      const chartInstance = useRef(null);
      
      const todayLog = logs.find(l => l.date === new Date().toISOString().split('T')[0]);
      
      const handleSaveLog = (log) => {
        onCheckin(log);
        setShowVoiceModal(false);
      };
      
      // Recommendation based on risk level
      const getRecommendation = () => {
        switch (insights.riskLevel) {
          case 'high':
            return { icon: 'üö®', text: 'Contact your GI, prepare flare kit', color: 'bg-red-50 text-red-800 border-red-200' };
          case 'medium':
            return { icon: '‚ö†Ô∏è', text: 'Monitor closely, consider reducing stress', color: 'bg-yellow-50 text-yellow-800 border-yellow-200' };
          default:
            return { icon: '‚úÖ', text: 'Continue tracking, stay hydrated', color: 'bg-green-50 text-green-800 border-green-200' };
        }
      };
      
      const recommendation = getRecommendation();
      
      // Chart
      useEffect(() => {
        if (chartRef.current && logs.length > 0) {
          if (chartInstance.current) chartInstance.current.destroy();
          
          const recentLogs = logs.slice(-14);
          const ctx = chartRef.current.getContext('2d');
          
          chartInstance.current = new Chart(ctx, {
            type: 'line',
            data: {
              labels: recentLogs.map(l => new Date(l.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
              datasets: [
                {
                  label: 'Pain Level',
                  data: recentLogs.map(l => l.painLevel || 0),
                  borderColor: '#ef4444',
                  backgroundColor: 'rgba(239, 68, 68, 0.1)',
                  tension: 0.4,
                  fill: true
                },
                {
                  label: 'Bowel Count',
                  data: recentLogs.map(l => l.bowelCount || 0),
                  borderColor: '#22c55e',
                  backgroundColor: 'rgba(34, 197, 94, 0.1)',
                  tension: 0.4,
                  fill: true
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 15 } } },
              scales: {
                y: { beginAtZero: true, max: 10, grid: { color: '#f3f4f6' } },
                x: { grid: { display: false } }
              }
            }
          });
        }
        return () => { if (chartInstance.current) chartInstance.current.destroy(); };
      }, [logs]);
      
      const riskColors = {
        low: 'from-green-400 to-green-500',
        medium: 'from-yellow-400 to-orange-500',
        high: 'from-red-400 to-red-500'
      };
      
      return (
        <div className="pb-24">
          {/* Voice Modal */}
          <VoiceLogModal
            isOpen={showVoiceModal}
            onClose={() => setShowVoiceModal(false)}
            onSave={handleSaveLog}
            user={user}
            existingLog={todayLog}
          />
          
          {/* Header */}
          <div className="bg-gradient-to-br from-gut-600 to-gut-700 text-white px-6 pt-6 pb-8 rounded-b-3xl">
            <div className="flex items-center justify-between mb-2">
              <div>
                <h1 className="text-2xl font-bold">GutSync</h1>
                <p className="text-gut-200 text-sm">{new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</p>
              </div>
              <div className="text-4xl">üåø</div>
            </div>
          </div>
          
          {/* ===== TOP SECTION: Flare Info ===== */}
          <div className="px-4 -mt-6">
            <div className="bg-white rounded-2xl shadow-lg p-4 border border-gray-100">
              <div className="grid grid-cols-2 gap-4 mb-4">
                {/* Last Flare */}
                <div className="text-center p-3 bg-gray-50 rounded-xl">
                  <div className="text-sm text-gray-500 mb-1">Last Flare</div>
                  {lastFlare ? (
                    <>
                      <div className="text-2xl font-bold text-gray-800">{lastFlare.daysAgo} days</div>
                      <div className="text-xs text-gray-400">{new Date(lastFlare.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
                    </>
                  ) : (
                    <div className="text-lg font-medium text-green-600">None recorded üéâ</div>
                  )}
                </div>
                
                {/* Flare Risk */}
                <div className="text-center p-3 bg-gray-50 rounded-xl">
                  <div className="text-sm text-gray-500 mb-1">Flare Risk (24-72h)</div>
                  {insights.riskPercent !== null ? (
                    <>
                      <div className={`text-2xl font-bold ${
                        insights.riskLevel === 'low' ? 'text-green-600' :
                        insights.riskLevel === 'medium' ? 'text-yellow-600' : 'text-red-600'
                      }`}>
                        {insights.riskPercent}%
                      </div>
                      <div className="text-xs text-gray-400 capitalize">{insights.riskLevel} risk</div>
                    </>
                  ) : (
                    <div className="text-lg font-medium text-gray-400">Calculating...</div>
                  )}
                </div>
              </div>
              
              {/* Recommendation */}
              <div className={`p-3 rounded-xl border ${recommendation.color}`}>
                <div className="flex items-center gap-2">
                  <span className="text-xl">{recommendation.icon}</span>
                  <span className="font-medium text-sm">{recommendation.text}</span>
                </div>
              </div>
            </div>
          </div>
          
          {/* ===== CENTER SECTION: Voice Log Button ===== */}
          <div className="px-4 mt-6 mb-6">
            <div className="text-center">
              <button
                onClick={() => setShowVoiceModal(true)}
                className={`relative w-36 h-36 rounded-full mx-auto flex flex-col items-center justify-center transition-all shadow-lg hover:shadow-xl ${
                  todayLog 
                    ? 'bg-gradient-to-br from-gray-400 to-gray-500' 
                    : 'bg-gradient-to-br from-gut-500 to-gut-600 hover:from-gut-600 hover:to-gut-700'
                }`}
              >
                {!todayLog && (
                  <div className="absolute inset-0 rounded-full bg-gut-400 voice-btn-ring opacity-50" />
                )}
                <span className="text-5xl mb-1">üé§</span>
                <span className="text-white text-sm font-medium">
                  {todayLog ? 'Edit Log' : 'Log Symptoms'}
                </span>
              </button>
              <p className="text-gray-500 text-sm mt-3">
                {todayLog ? 'Tap to update today\'s log' : 'Tap and tell me how you\'re feeling'}
              </p>
            </div>
          </div>
          
          {/* ===== BOTTOM SECTION: Recent Logs & Stats ===== */}
          
          {/* Quick Stats */}
          <div className="px-4 mb-4">
            <div className="grid grid-cols-3 gap-3">
              {(() => {
                const recent = logs.slice(-7);
                const avgPain = recent.length ? (recent.reduce((s, l) => s + (l.painLevel || 0), 0) / recent.length).toFixed(1) : '‚Äî';
                const avgBM = recent.length ? (recent.reduce((s, l) => s + (l.bowelCount || 0), 0) / recent.length).toFixed(1) : '‚Äî';
                const streak = (() => {
                  let count = 0;
                  const today = new Date();
                  for (let i = 0; i < 30; i++) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    if (logs.find(l => l.date === dateStr)) count++;
                    else if (i > 0) break;
                  }
                  return count;
                })();
                
                return (
                  <>
                    <div className="bg-white rounded-xl p-3 text-center border border-gray-100 shadow-sm">
                      <div className="text-2xl font-bold text-gut-600">{streak}</div>
                      <div className="text-xs text-gray-500">Day Streak üî•</div>
                    </div>
                    <div className="bg-white rounded-xl p-3 text-center border border-gray-100 shadow-sm">
                      <div className="text-2xl font-bold text-gray-800">{avgPain}</div>
                      <div className="text-xs text-gray-500">Avg Pain (7d)</div>
                    </div>
                    <div className="bg-white rounded-xl p-3 text-center border border-gray-100 shadow-sm">
                      <div className="text-2xl font-bold text-gray-800">{avgBM}</div>
                      <div className="text-xs text-gray-500">Avg BM (7d)</div>
                    </div>
                  </>
                );
              })()}
            </div>
          </div>
          
          {/* Recent Logs */}
          <div className="px-4">
            <h2 className="font-semibold text-gray-900 mb-3">Recent Logs</h2>
            <div className="space-y-2">
              {logs.slice(-5).reverse().map((log, i) => (
                <div key={i} className="bg-white rounded-xl p-4 border border-gray-100 shadow-sm flex items-center justify-between">
                  <div>
                    <div className="font-medium text-gray-900">
                      {new Date(log.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                    </div>
                    <div className="text-sm text-gray-500">
                      Pain: {log.painLevel}/10 ‚Ä¢ BM: {log.bowelCount} ‚Ä¢ Bristol: {log.bristolType || '‚Äî'}
                    </div>
                  </div>
                  <div className="text-2xl">
                    {log.painLevel <= 3 ? 'üü¢' : log.painLevel <= 6 ? 'üü°' : 'üî¥'}
                  </div>
                </div>
              ))}
              {logs.length === 0 && (
                <div className="text-center py-8 text-gray-400 bg-white rounded-xl border border-gray-100">
                  No logs yet. Start tracking!
                </div>
              )}
            </div>
          </div>
          
          {/* Trend Chart (collapsible) */}
          <div className="px-4 mt-6">
            <h2 className="font-semibold text-gray-900 mb-3">14-Day Trends</h2>
            <div className="bg-white rounded-xl p-4 border border-gray-100 shadow-sm">
              {logs.length > 0 ? (
                <div className="h-48">
                  <canvas ref={chartRef}></canvas>
                </div>
              ) : (
                <div className="h-32 flex items-center justify-center text-gray-400">
                  <div className="text-center">
                    <div className="text-3xl mb-2">üìä</div>
                    <p>Log symptoms to see trends</p>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };
    
    // Insights Screen
    const InsightsScreen = ({ logs, user, onBack }) => {
      const insights = generateInsights(logs, user);
      const recent = logs.slice(-7);
      
      // Calculate various metrics
      const avgPain = recent.length ? (recent.reduce((s, l) => s + (l.painLevel || 0), 0) / recent.length).toFixed(1) : 0;
      const avgBowel = recent.length ? (recent.reduce((s, l) => s + (l.bowelCount || 0), 0) / recent.length).toFixed(1) : 0;
      const avgHBI = recent.length ? (recent.reduce((s, l) => s + (l.hbi || 0), 0) / recent.length).toFixed(1) : 0;
      const looseDays = recent.filter(l => l.bristolType >= 6).length;
      
      // Find patterns
      const extraCounts = {};
      recent.forEach(l => (l.extras || []).forEach(e => { extraCounts[e] = (extraCounts[e] || 0) + 1; }));
      const topExtras = Object.entries(extraCounts).sort((a, b) => b[1] - a[1]).slice(0, 3);
      
      return (
        <div className="min-h-screen bg-gray-50 pb-24">
          <div className="bg-white border-b border-gray-200 px-4 py-3 flex items-center">
            <button onClick={onBack} className="text-gut-600 font-medium mr-4">‚Üê Back</button>
            <h2 className="font-semibold">AI Insights</h2>
          </div>
          
          <div className="p-4 space-y-4">
            {/* Flare Risk */}
            <div className="bg-white rounded-xl p-4 border border-gray-200">
              <h3 className="font-semibold text-gray-900 mb-3">Flare Risk Prediction</h3>
              <div className="flex items-center gap-4">
                <div className={`w-20 h-20 rounded-full flex items-center justify-center text-white text-xl font-bold ${
                  insights.riskLevel === 'low' ? 'bg-green-500' : 
                  insights.riskLevel === 'medium' ? 'bg-yellow-500' : 
                  insights.riskLevel === 'high' ? 'bg-red-500' : 'bg-gray-400'
                }`}>
                  {insights.riskPercent !== null ? `${insights.riskPercent}%` : '‚Äî'}
                </div>
                <div className="flex-1">
                  <div className="font-medium text-gray-900">
                    {insights.riskLevel ? insights.riskLevel.charAt(0).toUpperCase() + insights.riskLevel.slice(1) + ' Risk' : 'Calculating...'}
                  </div>
                  <p className="text-sm text-gray-500">{insights.details}</p>
                  <p className="text-xs text-gray-400 mt-1">Prediction window: next 24-72 hours</p>
                </div>
              </div>
            </div>
            
            {/* Weekly Summary */}
            <div className="bg-white rounded-xl p-4 border border-gray-200">
              <h3 className="font-semibold text-gray-900 mb-3">7-Day Summary</h3>
              <div className="grid grid-cols-2 gap-4">
                <div className="text-center p-3 bg-gray-50 rounded-lg">
                  <div className="text-2xl font-bold text-gray-900">{avgPain}</div>
                  <div className="text-sm text-gray-500">Avg Pain</div>
                </div>
                <div className="text-center p-3 bg-gray-50 rounded-lg">
                  <div className="text-2xl font-bold text-gray-900">{avgBowel}</div>
                  <div className="text-sm text-gray-500">Avg BM/Day</div>
                </div>
                <div className="text-center p-3 bg-gray-50 rounded-lg">
                  <div className="text-2xl font-bold text-gray-900">{looseDays}</div>
                  <div className="text-sm text-gray-500">Loose Stool Days</div>
                </div>
                <div className="text-center p-3 bg-gray-50 rounded-lg">
                  <div className="text-2xl font-bold text-gray-900">{avgHBI}</div>
                  <div className="text-sm text-gray-500">Avg HBI Score</div>
                </div>
              </div>
            </div>
            
            {/* Pattern Detection */}
            <div className="bg-white rounded-xl p-4 border border-gray-200">
              <h3 className="font-semibold text-gray-900 mb-3">Detected Patterns</h3>
              {topExtras.length > 0 ? (
                <div className="space-y-2">
                  {topExtras.map(([id, count]) => {
                    const symptom = EXTRA_SYMPTOMS.find(s => s.id === id);
                    return symptom ? (
                      <div key={id} className="flex items-center justify-between p-2 bg-orange-50 rounded-lg">
                        <span>{symptom.icon} {symptom.label}</span>
                        <span className="text-sm text-gray-500">{count} days this week</span>
                      </div>
                    ) : null;
                  })}
                  <p className="text-sm text-gray-500 mt-2">
                    üí° These symptoms appeared frequently. Track food and stress to find correlations.
                  </p>
                </div>
              ) : (
                <p className="text-gray-500">Not enough data to detect patterns yet. Keep logging!</p>
              )}
            </div>
            
            {/* Mock Integrations */}
            <div className="bg-white rounded-xl p-4 border border-gray-200">
              <h3 className="font-semibold text-gray-900 mb-3">Health Integrations</h3>
              <div className="space-y-3">
                <div className="flex items-center justify-between p-3 border border-dashed border-gray-300 rounded-lg">
                  <div className="flex items-center gap-3">
                    <span className="text-2xl">‚åö</span>
                    <div>
                      <div className="font-medium">Apple Health</div>
                      <div className="text-sm text-gray-500">HRV, Sleep, Activity</div>
                    </div>
                  </div>
                  <button className="text-gut-600 font-medium text-sm">Connect</button>
                </div>
                <div className="flex items-center justify-between p-3 border border-dashed border-gray-300 rounded-lg">
                  <div className="flex items-center gap-3">
                    <span className="text-2xl">üí™</span>
                    <div>
                      <div className="font-medium">WHOOP</div>
                      <div className="text-sm text-gray-500">Recovery Score, Strain</div>
                    </div>
                  </div>
                  <button className="text-gut-600 font-medium text-sm">Connect</button>
                </div>
              </div>
              <div className="mt-4 p-3 bg-blue-50 rounded-lg">
                <p className="text-sm text-blue-800">
                  <strong>Coming Soon:</strong> Connect wearables to detect flares 24-72 hours earlier using HRV and sleep patterns.
                </p>
              </div>
            </div>
          </div>
        </div>
      );
    };
    
    // Doctor Report Screen
    const DoctorReport = ({ logs, user, onBack }) => {
      const [dateRange, setDateRange] = useState(30);
      const [generating, setGenerating] = useState(false);
      
      const filteredLogs = useMemo(() => {
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - dateRange);
        return logs.filter(l => new Date(l.date) >= cutoff);
      }, [logs, dateRange]);
      
      const stats = useMemo(() => {
        if (!filteredLogs.length) return null;
        return {
          avgPain: (filteredLogs.reduce((s, l) => s + (l.painLevel || 0), 0) / filteredLogs.length).toFixed(1),
          avgBowel: (filteredLogs.reduce((s, l) => s + (l.bowelCount || 0), 0) / filteredLogs.length).toFixed(1),
          avgHBI: (filteredLogs.reduce((s, l) => s + (l.hbi || 0), 0) / filteredLogs.length).toFixed(1),
          totalLogs: filteredLogs.length,
          looseDays: filteredLogs.filter(l => l.bristolType >= 6).length,
          highPainDays: filteredLogs.filter(l => l.painLevel >= 7).length,
          adherence: user?.medications?.length 
            ? Math.round((filteredLogs.reduce((s, l) => s + (l.medsTaken?.length || 0), 0) / (filteredLogs.length * user.medications.length)) * 100)
            : null
        };
      }, [filteredLogs, user]);
      
      const generatePDF = () => {
        setGenerating(true);
        
        const report = `
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                    GUTSYNC PATIENT REPORT                     ‚ïë
‚ïë                  Crohn's Disease Symptom Summary              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

PATIENT INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Diagnosis Date: ${user?.diagnosisDate || 'Not specified'}
Report Period: Last ${dateRange} days
Generated: ${new Date().toLocaleDateString()}

SUMMARY STATISTICS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Total Logs: ${stats?.totalLogs || 0} entries
Average Pain Level: ${stats?.avgPain || 0}/10
Average Bowel Movements: ${stats?.avgBowel || 0}/day
Average Harvey-Bradshaw Index: ${stats?.avgHBI || 0}
Days with Loose Stools (Bristol 6-7): ${stats?.looseDays || 0}
Days with High Pain (‚â•7): ${stats?.highPainDays || 0}
${stats?.adherence !== null ? `Medication Adherence: ${stats.adherence}%` : ''}

MEDICATIONS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${(user?.medications || []).join('\n') || 'None recorded'}

HARVEY-BRADSHAW INDEX INTERPRETATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Score < 5: Remission
‚Ä¢ Score 5-7: Mild disease
‚Ä¢ Score 8-16: Moderate disease  
‚Ä¢ Score > 16: Severe disease
Patient Average: ${stats?.avgHBI || 0}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Generated by GutSync - AI-Powered Crohn's Tracker
This report is for informational purposes and should be 
reviewed with your healthcare provider.
        `.trim();
        
        setTimeout(() => {
          const blob = new Blob([report], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `GutSync_Report_${new Date().toISOString().split('T')[0]}.txt`;
          a.click();
          URL.revokeObjectURL(url);
          setGenerating(false);
        }, 1000);
      };
      
      return (
        <div className="min-h-screen bg-gray-50 pb-24">
          <div className="bg-white border-b border-gray-200 px-4 py-3 flex items-center">
            <button onClick={onBack} className="text-gut-600 font-medium mr-4">‚Üê Back</button>
            <h2 className="font-semibold">Doctor Report</h2>
          </div>
          
          <div className="p-4 space-y-4">
            {/* Date Range */}
            <div className="bg-white rounded-xl p-4 border border-gray-200">
              <h3 className="font-semibold text-gray-900 mb-3">Report Period</h3>
              <div className="flex gap-2">
                {[7, 14, 30, 90].map(d => (
                  <button
                    key={d}
                    onClick={() => setDateRange(d)}
                    className={`flex-1 py-2 rounded-lg font-medium transition ${
                      dateRange === d 
                        ? 'bg-gut-600 text-white' 
                        : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                    }`}
                  >
                    {d}d
                  </button>
                ))}
              </div>
            </div>
            
            {/* Preview */}
            {stats ? (
              <div className="bg-white rounded-xl p-4 border border-gray-200">
                <h3 className="font-semibold text-gray-900 mb-3">Report Preview</h3>
                <div className="space-y-3">
                  <div className="flex justify-between py-2 border-b border-gray-100">
                    <span className="text-gray-600">Logs Recorded</span>
                    <span className="font-medium">{stats.totalLogs}</span>
                  </div>
                  <div className="flex justify-between py-2 border-b border-gray-100">
                    <span className="text-gray-600">Avg Pain Level</span>
                    <span className="font-medium">{stats.avgPain}/10</span>
                  </div>
                  <div className="flex justify-between py-2 border-b border-gray-100">
                    <span className="text-gray-600">Avg BM/Day</span>
                    <span className="font-medium">{stats.avgBowel}</span>
                  </div>
                  <div className="flex justify-between py-2 border-b border-gray-100">
                    <span className="text-gray-600">Avg HBI Score</span>
                    <span className={`font-medium ${
                      stats.avgHBI < 5 ? 'text-green-600' : 
                      stats.avgHBI < 8 ? 'text-yellow-600' : 'text-red-600'
                    }`}>
                      {stats.avgHBI} ({stats.avgHBI < 5 ? 'Remission' : stats.avgHBI < 8 ? 'Mild' : 'Moderate'})
                    </span>
                  </div>
                  <div className="flex justify-between py-2 border-b border-gray-100">
                    <span className="text-gray-600">Loose Stool Days</span>
                    <span className="font-medium">{stats.looseDays}</span>
                  </div>
                  <div className="flex justify-between py-2 border-b border-gray-100">
                    <span className="text-gray-600">High Pain Days</span>
                    <span className="font-medium">{stats.highPainDays}</span>
                  </div>
                  {stats.adherence !== null && (
                    <div className="flex justify-between py-2">
                      <span className="text-gray-600">Med Adherence</span>
                      <span className={`font-medium ${stats.adherence >= 80 ? 'text-green-600' : 'text-orange-600'}`}>
                        {stats.adherence}%
                      </span>
                    </div>
                  )}
                </div>
              </div>
            ) : (
              <div className="bg-white rounded-xl p-8 border border-gray-200 text-center text-gray-500">
                <div className="text-4xl mb-2">üìä</div>
                <p>No data in selected period</p>
              </div>
            )}
            
            {/* HBI Info */}
            <div className="bg-blue-50 rounded-xl p-4 border border-blue-200">
              <h4 className="font-semibold text-blue-900 mb-2">About Harvey-Bradshaw Index</h4>
              <p className="text-sm text-blue-800 mb-2">
                The HBI is a simplified clinical index used by gastroenterologists to assess Crohn's disease activity.
              </p>
              <div className="text-sm text-blue-700 space-y-1">
                <div>‚Ä¢ &lt;5: Remission</div>
                <div>‚Ä¢ 5-7: Mild disease</div>
                <div>‚Ä¢ 8-16: Moderate disease</div>
                <div>‚Ä¢ &gt;16: Severe disease</div>
              </div>
            </div>
            
            {/* Generate Button */}
            <button
              onClick={generatePDF}
              disabled={!stats || generating}
              className="w-full py-4 bg-gut-600 text-white rounded-xl font-semibold hover:bg-gut-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2"
            >
              {generating ? (
                <>‚è≥ Generating...</>
              ) : (
                <>üì• Download Report</>
              )}
            </button>
            
            <p className="text-sm text-gray-500 text-center">
              Share this report with your GI doctor to review your symptom patterns.
            </p>
          </div>
        </div>
      );
    };
    
    // Bottom Navigation
    const BottomNav = ({ active, onNavigate }) => (
      <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 safe-area-bottom">
        <div className="flex justify-around py-2">
          {[
            { id: 'dashboard', icon: 'üè†', label: 'Home' },
            { id: 'insights', icon: 'ü§ñ', label: 'Insights' },
            { id: 'report', icon: 'üìã', label: 'Report' }
          ].map(item => (
            <button
              key={item.id}
              onClick={() => onNavigate(item.id)}
              className={`flex flex-col items-center py-2 px-4 ${
                active === item.id ? 'text-gut-600' : 'text-gray-400'
              }`}
            >
              <span className="text-xl">{item.icon}</span>
              <span className="text-xs mt-1">{item.label}</span>
            </button>
          ))}
        </div>
      </div>
    );
    
    // Main App
    const App = () => {
      const [isOnboarded, setIsOnboarded] = useState(() => loadData(STORAGE_KEYS.ONBOARDED, false));
      const [user, setUser] = useState(() => loadData(STORAGE_KEYS.USER, null));
      const [logs, setLogs] = useState(() => loadData(STORAGE_KEYS.LOGS, []));
      const [screen, setScreen] = useState('dashboard');
      
      const handleOnboardingComplete = (userData, demoLogs) => {
        setUser(userData);
        if (demoLogs) setLogs(demoLogs);
        setIsOnboarded(true);
      };
      
      const handleSaveLog = (log) => {
        const existingIndex = logs.findIndex(l => l.date === log.date);
        let newLogs;
        if (existingIndex >= 0) {
          newLogs = [...logs];
          newLogs[existingIndex] = log;
        } else {
          newLogs = [...logs, log];
        }
        newLogs.sort((a, b) => new Date(a.date) - new Date(b.date));
        setLogs(newLogs);
        saveData(STORAGE_KEYS.LOGS, newLogs);
      };
      
      if (!isOnboarded) {
        return <OnboardingFlow onComplete={handleOnboardingComplete} />;
      }
      
      return (
        <div className="min-h-screen bg-gray-50">
          {screen === 'dashboard' && (
            <Dashboard 
              user={user} 
              logs={logs} 
              onCheckin={handleSaveLog}
              onViewInsights={() => setScreen('insights')}
              onViewReport={() => setScreen('report')}
            />
          )}
          
          {screen === 'insights' && (
            <InsightsScreen 
              logs={logs} 
              user={user} 
              onBack={() => setScreen('dashboard')}
            />
          )}
          
          {screen === 'report' && (
            <DoctorReport 
              logs={logs} 
              user={user} 
              onBack={() => setScreen('dashboard')}
            />
          )}
          
          <BottomNav active={screen} onNavigate={setScreen} />
        </div>
      );
    };
    
    // Render
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
